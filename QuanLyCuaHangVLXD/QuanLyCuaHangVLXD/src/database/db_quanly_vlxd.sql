USE Master
CREATE DATABASE	QuanLyCuaHangVLXD

GO

Use QuanLyCuaHangVLXD

GO

/*Tạo Mã Khách Hàng Tự Động*/
CREATE FUNCTION AUTO_IDKH()
RETURNS VARCHAR(5)
AS
BEGIN
	DECLARE @ID VARCHAR(5)
	IF (SELECT COUNT(MAKH) FROM KHACHHANG) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MAKH, 3)) FROM KHACHHANG
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'KH00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'KH0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO

/*Bảng Khách Hàng*/
CREATE TABLE KhachHang
(
	MAKH CHAR(5) PRIMARY KEY CONSTRAINT IDKH DEFAULT DBO.AUTO_IDKH(),
	TENKH NVARCHAR(30) NOT NULL,
	GIOITINH NVARCHAR(5) NOT NULL,
	NGAYSINH date,
	EMAIL CHAR(30),
	DIENTHOAI CHAR(12),
	CMND INT,
	DIACHI NVARCHAR(40),
)

GO

CREATE PROC select_KH
as
	SELECT * FROM [dbo].[KhachHang]

GO

/*Tạo Mã Chức Vụ Tự Động*/
CREATE FUNCTION AUTO_IDCV()
RETURNS VARCHAR(5)
AS
BEGIN
	DECLARE @ID VARCHAR(5)
	IF (SELECT COUNT(MACV) FROM CHUCVU) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MACV, 3)) FROM CHUCVU
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'CV00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'CV0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO

/*Bảng Chức Vụ*/
CREATE TABLE ChucVu
(
	MACV CHAR(5) PRIMARY KEY CONSTRAINT IDCV DEFAULT DBO.AUTO_IDCV(),
	TENCV NVARCHAR(30) NOT NULL,
	HESOLUONG FLOAT
)

GO

CREATE PROC select_CV
as
	SELECT * FROM [dbo].[ChucVu]

GO

/*Tạo Mã Nhân Viên Tự Động*/
CREATE FUNCTION AUTO_IDNV()
RETURNS VARCHAR(5)
AS
BEGIN
	DECLARE @ID VARCHAR(5)
	IF (SELECT COUNT(MANV) FROM NHANVIEN) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MANV, 3)) FROM NHANVIEN
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'NV00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'NV0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO

/*Bảng Nhân Viên*/
CREATE TABLE NhanVien
(
	MANV CHAR(5) PRIMARY KEY CONSTRAINT IDNV DEFAULT DBO.AUTO_IDNV(),
	MACV CHAR(5) NOT NULL,
	CONSTRAINT fk_MaChucVu
	FOREIGN KEY(MACV)
	REFERENCES CHUCVU(MACV)
	ON DELETE CASCADE ON UPDATE CASCADE,
	TENNV NVARCHAR(30) NOT NULL,
	GIOITINH NVARCHAR(5) NOT NULL,
	NGAYSINH DATE,
	EMAIL CHAR(30),
	DIENTHOAI CHAR(12),
	CMND INT,
	DIACHI NVARCHAR(40),
	NGAYVAOLAM DATE,
)

GO

/*Tạo Proceduce Lấy Danh Sách Nhân Viên*/
CREATE PROC select_NV
as
	SELECT * FROM [dbo].[NhanVien]

GO

/*Tạo Mã Loại Vật Liệu Tự Động*/
CREATE FUNCTION AUTO_IDLVL()
RETURNS VARCHAR(6)
AS
BEGIN
	DECLARE @ID VARCHAR(6)
	IF (SELECT COUNT(MALOAI) FROM LOAIVATLIEU) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MALOAI, 3)) FROM LOAIVATLIEU
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'LVL00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'LVL0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO

/*Bảng Loại Vật Liệu*/
CREATE TABLE LoaiVatLieu
(
	MALOAI CHAR(6) PRIMARY KEY CONSTRAINT IDLT DEFAULT DBO.AUTO_IDLVL(),
	TENLOAI NVARCHAR(30) NOT NULL,
)

GO

CREATE PROC select_LVL
as
	SELECT * FROM [dbo].[LoaiVatLieu]

GO

/*Tạo Mã Vật Liệu Tự Động*/
CREATE FUNCTION AUTO_IDVL()
RETURNS VARCHAR(5)
AS
BEGIN
	DECLARE @ID VARCHAR(5)
	IF (SELECT COUNT(MAVL) FROM VATLIEU) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MAVL, 3)) FROM VATLIEU
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'VL00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'VL0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO

/*Bảng Vat Lieu*/
CREATE TABLE VatLieu
(
	MAVL CHAR(5) PRIMARY KEY CONSTRAINT IDVL DEFAULT DBO.AUTO_IDVL(),
	MALOAI CHAR(6) NOT NULL,
	CONSTRAINT fk_MaLoai
	FOREIGN KEY(MALOAI)
	REFERENCES LOAIVATLIEU(MALOAI)
	ON DELETE CASCADE ON UPDATE CASCADE,
	TENVATLIEU NVARCHAR(30) NOT NULL,
	TRONGLUONG FLOAT,
	DONVITINH NVARCHAR(70),
	XUATXU NVARCHAR(50),
	SOLUONG INT,
	GIABAN FLOAT,
)

GO

CREATE PROC select_VL
as
	SELECT * FROM [dbo].[VatLieu]

GO

/*id nhà cung cấp*/
CREATE FUNCTION AUTO_IDNCC()
RETURNS VARCHAR(6)
AS
BEGIN
	DECLARE @ID VARCHAR(6)
	IF (SELECT COUNT(MANHACC) FROM NHACUNGCAP) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MANHACC, 3)) FROM NHACUNGCAP
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'NCC00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'NCC0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO

/*Bảng Nhà Cung Cấp*/
CREATE TABLE NhaCungCap
(
	MANHACC CHAR(6) PRIMARY KEY CONSTRAINT IDNCC DEFAULT DBO.AUTO_IDNCC(),
	TENNHACC NVARCHAR(30) NOT NULL,
	DIACHI NVARCHAR(50) NOT NULL,
	SODT CHAR(30) NOT NULL,
	EMAIL CHAR(30) NOT NULL
)

GO

CREATE PROC select_NCC
as
	SELECT * FROM [dbo].[NhaCungCap]

GO

/*HoaDonBanHang*/
CREATE FUNCTION AUTO_IDHDBH()
RETURNS VARCHAR(7)
AS
BEGIN
	DECLARE @ID VARCHAR(7)
	IF (SELECT COUNT(MAHDBH) FROM HOADONBANHANG) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MAHDBH, 3)) FROM HOADONBANHANG
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'HDBH00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'HDBH0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO

CREATE TABLE HoaDonBanHang
(
	MaHDBH CHAR(7) PRIMARY KEY CONSTRAINT IDHDBH DEFAULT DBO.AUTO_IDHDBH(),
	MAKH CHAR(5) NOT NULL,
	MANV CHAR(5) NOT NULL,
	NGAYLAPHD DATE,
	TONGTIEN FLOAT,
	CONSTRAINT fk_MaKHMH
	FOREIGN KEY(MAKH)
	REFERENCES KHACHHANG(MAKH)
	ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT fk_MaNV
	FOREIGN KEY(MANV)
	REFERENCES NHANVIEN(MANV)
	ON DELETE CASCADE ON UPDATE CASCADE,
)

GO

/*CT*/
CREATE TABLE CT_HoaDonBanHang
(
	MaHDBH CHAR(7) NOT NULL,
	MAVL CHAR(5) NOT NULL,
	SOLUONG INT,
	DONGIA FLOAT,
	CONSTRAINT pk_CTHDBH
	PRIMARY KEY(MAHDBH,MAVL),
	CONSTRAINT fk_MaHDBH
	FOREIGN KEY(MAHDBH)
	REFERENCES HOADONBANHANG(MAHDBH)
	ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT fk_MALKB
	FOREIGN KEY(MAVL)
	REFERENCES VATLIEU(MAVL)
	ON DELETE CASCADE ON UPDATE CASCADE,
)

GO

CREATE FUNCTION AUTO_IDHDNH()
RETURNS VARCHAR(7)
AS
BEGIN
	DECLARE @ID VARCHAR(7)
	IF (SELECT COUNT(MAHDNH) FROM HOADONNHAPHANG) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MAHDNH, 3)) FROM HOADONNHAPHANG
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'HDNH00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'HDNH0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO

CREATE TABLE HoaDonNhapHang
(
	MaHDNH CHAR(7) PRIMARY KEY CONSTRAINT IDHDNH DEFAULT DBO.AUTO_IDHDNH(),
	MANHACC CHAR(6) NOT NULL,
	MANV CHAR(5) NOT NULL,
	NGAYLAPHD DATE,
	TONGTIEN FLOAT,
	CONSTRAINT fk_MaNCCLK
	FOREIGN KEY(MANHACC)
	REFERENCES NHACUNGCAP(MANHACC)
	ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT fk_MaNVNH
	FOREIGN KEY(MANV)
	REFERENCES NHANVIEN(MANV)
	ON DELETE CASCADE ON UPDATE CASCADE,
)

GO

CREATE TABLE CT_HoaDonNhapHang
(
	MaHDNH CHAR(7) NOT NULL,
	MAVL CHAR(5) NOT NULL,
	SOLUONG INT,
	DONGIA FLOAT,
	CONSTRAINT pk_CTHDNH
	PRIMARY KEY(MAHDNH,MAVL),
	CONSTRAINT fk_MaHDNH
	FOREIGN KEY(MAHDNH)
	REFERENCES HOADONNHAPHANG(MAHDNH)
	ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT fk_MALKN
	FOREIGN KEY(MAVL)
	REFERENCES VATLIEU(MAVL)
	ON DELETE CASCADE ON UPDATE CASCADE,
)

GO

CREATE FUNCTION AUTO_IDTK()
RETURNS VARCHAR(5)
AS
BEGIN
	DECLARE @ID VARCHAR(5)
	IF (SELECT COUNT(MATK) FROM TAIKHOAN) = 0
		SET @ID = '0'
	ELSE
		SELECT @ID = MAX(RIGHT(MATK, 3)) FROM TAIKHOAN
		SELECT @ID = CASE
			WHEN @ID >= 0 and @ID < 9 THEN 'TK00' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
			WHEN @ID >= 9 THEN 'TK0' + CONVERT(CHAR, CONVERT(INT, @ID) + 1)
		END
	RETURN @ID
END

GO

CREATE TABLE TaiKhoan
(
	MATK CHAR(5) PRIMARY KEY CONSTRAINT IDTK DEFAULT DBO.AUTO_IDTK(),
	TENDN CHAR(15) NOT NULL,
	MATKHAU CHAR(30) NOT NULL,
	MANV CHAR(5) NOT NULL,
	CONSTRAINT fk_MAQ
	FOREIGN KEY(MANV)
	REFERENCES NHANVIEN(MANV)
	ON DELETE CASCADE ON UPDATE CASCADE,
)

GO

CREATE PROC select_TK
as
	SELECT * FROM [dbo].[TaiKhoan]

GO

INSERT INTO [dbo].[KhachHang]([TENKH],[GIOITINH],[NGAYSINH],[EMAIL],[DIENTHOAI],[CMND],[DIACHI])
VALUES(N'Nguyễn Văn Hùng','Nam','2000-04-25','hungcoder254@gmail.com','096969999',13489654,N'Gò Vấp, TP.Hồ Chí Minh')

GO

INSERT INTO [dbo].[ChucVu]([TENCV],[HESOLUONG])
VALUES(N'Admin',2.0)

GO

INSERT INTO [dbo].[NhanVien]([MACV],[TENNV],[GIOITINH],[NGAYSINH],[EMAIL],[DIENTHOAI],[CMND],[DIACHI],[NGAYVAOLAM])
VALUES('CV001',N'Nguyễn Văn Hùng','Nam','2000-04-25','hungcoder254@gmail.com','096969999',13489654,N'Gò Vấp, TP.Hồ Chí Minh','2022-11-25')

GO

INSERT INTO [dbo].[TaiKhoan]([MATK], [TENDN], [MATKHAU], [MANV])
VALUES('TK001', 'hungadmin', '123456', 'NV001')
